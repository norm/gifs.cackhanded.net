#!/usr/bin/env bash -oeu pipefail

count="${1:-60}"
days=''
empty=''
full=''

shift
while [ "${1:-}" ]; do
    case "${1:-}" in
        empty)  empty=empty full=''  ;;
        full)   full=full   empty='' ;;
        *)      [ -n "$days" ] && days="$days|$1" || days="$1"
    esac
    shift
done

for day in $(seq 0 ${count}); do
    datestamp=$(gdate +'%Y-%m-%d' --date="now $day days")
    day=$(gdate +%a --date $datestamp)

    [ -n "$days" ] \
        && echo "$day" | egrep -iqv "$days" \
        && continue

    content=$(
        ( ag published.*$datestamp source || echo '' ) \
            | cut -d: -f1 \
            | sed -e 's#source/##' \
                  -e 's/.toml//'
    )

    [ -n "$content" -a -n "$empty" ] && continue
    [ -z "$content" -a -n "$full" ] && continue

    echo "$datestamp $(gdate +%a --date $datestamp) $content"

done
