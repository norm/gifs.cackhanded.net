#!/bin/sh

set -eu

new="$1"

index="$(dirname $new)"
toml="source/$new.toml"
dir="$(dirname $toml)"
video="$(basename $dir)"

mkdir -p $dir
cat <<EOF > $toml
title = '${2:-}'
published = $(date "+%Y-%m-%dT%H:%M:%SZ")
source_fkey = '$index/index'
tag = ['TAG_ME']
body_markdown = """

WRITE_ME

"""

[video]
source   = 'file'
file     = '$video'
ext      = 'm4v'
start    = '00:00:00.0'
duration = '4'
# end      = '00:00:00.0'
# crop     = '1200:675'

[output]
# brightness = '0'
# colours    = '48'
# dither     = 'bayer:bayer_scale=0-5'
# dither     = 'floyd_steinberg'
# dither     = 'sierra2'
# dither     = 'sierra2_4a'
# fps        = '12'
# fps        = '18'
# loss       = '0'
# max_size   = '0.9mb'   # 2s
# max_size   = '1.35mb'  # 3s
# max_size   = '1.8mb'   # 4s
# max_size   = '2.25mb'  # 5s
# max_size   = '2.7mb'   # 6s
# max_size   = '3.15mb'  # 7s
# max_size   = '3.6mb'   # 8s
# max_size   = '4.05mb'  # 9s
# max_size   = '4.5mb'   # 10s
# mode       = 'full'
# width      = 'original'

# values for during creation to help get timings right
colours  = '256'
fps      = 'original'
width    = '800'
loss     = 'no'
timing   = 'yes'


# [[clip]]
# start = '1'
# end   = '2'

# [[caption]]
# text      = "Looks like I picked the\nwrong week to give up drinking"
# from      = '0'
# to        = '1.7'
# # not required, but can be used if needed
# # align     = 'center'
# # colour    = 'white'
# # font      = 'assistant-extrabold.ttf'
# # margin    = '10'
# # placement = 'bc'
# # size      = '24'
# # stroke_colour = 'black'
# # stroke_width  = '2'
EOF

subl -w $toml
subl $toml
./script/get_videos $toml
make
open -a Safari source/$new.gif
