#!/bin/bash

set -eu

export AV_LOG_FORCE_NOCOLOR=1

DEFAULT_WIDTH=480
DEFAULT_FPS=10
DEBUG="${GIF_DEBUG:-}"


function main {
    local toml="$1"
    local gif="$2"
    local video="${3:-}"

    if [ -z "$video" ]; then
        file=$(toml $toml video.file)
        ext=$(toml $toml video.ext)
        video="videos/${file}.${ext}"
    fi

    if [ ! -f "$video" ]; then
        echo " ** $video does not exist"
        exit 1
    fi

    # crop the image
    video_crop="$(toml $toml video.crop)"
    crop=''
    [ -n "$video_crop" ] \
        && crop="crop=${video_crop}"

    # resize the image, preserving the aspect ratio
    output_width="$(toml $toml output.width)"
    if [ "$output_width" == 'original' ]; then
        scale=''
    else
        scale="scale=${output_width:-$DEFAULT_WIDTH}:-1"
    fi

    # reduce the framerate
    output_fps="$(toml $toml output.fps)"
    if [ "$output_fps" == 'original' ]; then
        fps=''
    else
        fps="fps=${output_fps:-$DEFAULT_FPS}"
    fi

    # reduce no. of colours in the uniform palette
    output_colours="$(toml $toml output.colours)"
    max_cols="max_colors=${output_colours:-64}"

    # dithering to improve output
    output_mode="$(toml $toml output.mode)"
    mode="stats_mode=${output_mode:-diff}"
    output_dither="$(toml $toml output.dither)"
    dither="dither=${output_dither:-bayer:bayer_scale=4}"
    diff_mode="diff_mode=rectangle"

    # clips
    extract_clips=''
    join_clips=''
    filter=''
    num_clips="$(toml $toml clip --length)"
    if [ "$num_clips" -gt 0 ]; then
        if [ -n "$fps" ]; then
            stream="[0:v] ${fps},"
        else
            stream="[0:v] "
        fi
        for index in $(seq 1 $num_clips); do
            clip_start="$(toml $toml clip.start $index)"
            start="$(to_seconds $clip_start)"
            clip_end="$(toml $toml clip.end $index)"
            end="$(to_seconds $clip_end)"
            extract_clips+="${stream} trim=start=${start}:end=${end},"
            extract_clips+="setpts=PTS-STARTPTS [c$index]; "
            join_clips+="[c$index]"
        done
        join_clips+="concat=n=$index:v=1"
        extract_clips+=" $join_clips"
        input_filter=$(join ',' "$crop" "$scale")
        if [ -n "$input_filter" ]; then
            filter+="$extract_clips [vs];[vs] $input_filter [iv];"
        else
            filter+="$extract_clips [iv];"
        fi
    else
        input_filter=$(join ',' "$fps" "$crop" "$scale")
        filter="[0:v] $input_filter [iv];"
    fi

    # main video timings
    timing_args=''
    start=$(toml $toml video.start)
    [ -n "$start" ] && timing_args="$timing_args -ss $start"
    duration=$(toml $toml video.duration)
    [ -n "$duration" ] && timing_args="$timing_args -t $duration"
    end=$(toml $toml video.end)
    [ -n "$end" ] && timing_args="$timing_args -to $end"

    # calculate the palette
    debug ffmpeg \
        -loglevel error \
        -y \
        ${timing_args} \
        -i "$video" \
        -filter_complex "$filter [iv] palettegen=${max_cols}:${mode}" \
        "${TEMP}/palette.png"

    size_filter="$(join ',' "$crop" "$scale")"
    debug ffmpeg \
        -loglevel error -y -ss 0 -t 0.01 -i "$video" \
        -filter_complex "[0:v] ${size_filter:-scale=w=in_w:h=in_h}" \
        ${TEMP}/size.gif
    output_width="$( file $TEMP/size.gif | awk '{ print $7 }')"
    output_height="$( file $TEMP/size.gif | awk '{ print $9 }')"
    echo "    ${output_width} x ${output_height}"

    # captions
    num_captions="$(toml $toml caption --length)"
    caption_args=""
    caption_colours=""
    if [ "$num_captions" -gt 0 ]; then
        # determine output size

        for index in $(seq 1 $num_captions); do
            let "input = index + 1"
            caption_text="$(toml $toml caption.text $index)"
            caption_placement="$(toml $toml caption.placement $index)"
            caption_size="$(toml $toml caption.size $index)"
            caption_margin="$(toml $toml caption.margin $index)"
            caption_font="$(toml $toml caption.font $index)"
            caption_colour="$(toml $toml caption.colour $index)"
            caption_strokew="$(toml $toml caption.stroke_width $index)"
            caption_strokecol="$(toml $toml caption.stroke_colour $index)"
            caption_align="$(toml $toml caption.align $index)"
            caption \
                ${output_width:-$DEFAULT_WIDTH} \
                $output_height \
                --colour "${caption_colour:-#ffffff}" \
                --font "${caption_font:-morlrounded-regular.otf}" \
                --font-size "${caption_size:-40}" \
                --margin "${caption_margin:-10}" \
                --stroke-width "${caption_strokew:-2}" \
                --stroke-colour "${caption_strokecol:-#000000}" \
                --text-align "${caption_align:-left}" \
                --placement ${caption_placement:-bl} \
                "${caption_text}" \
                "${TEMP}/caption-${index}.png"

            caption_colours+=" ${caption_colour:-#ffffff}"
            caption_colours+=" ${caption_strokecol:-#000000}"

            caption_from="$(toml $toml caption.from $index)"
            caption_to="$(toml $toml caption.to $index)"

            position="(main_w-overlay_w):(main_h-overlay_h)"
            timing="${caption_from:-0},${caption_to:-1000}"
            overlay="overlay=${position}:enable='between(t,${timing})'"

            if [ $index = 1 ]; then
                filter+=" [iv][$input:v] ${overlay} [v$index];"
            else
                filter+=" [v$((index-1))][$input:v] ${overlay} [v$index];"
            fi
            caption_args+=" -i ${TEMP}/caption-${index}.png"
        done
        filter+=" [v$index][1:v] paletteuse=${dither}:${diff_mode}"
    else
        filter+=" [iv][1:v] paletteuse=${dither}:${diff_mode}"
    fi

    edit-palette "${TEMP}/palette.png" $caption_colours

    debug ffmpeg \
        -loglevel error \
        -y \
        ${timing_args} \
        -i "$video" \
        -i "${TEMP}/palette.png" \
        ${caption_args} \
        -f gif \
        -filter_complex "$filter" \
        "${TEMP}/output.gif"

    uncompressed_size="$(stat -f '%z' "${TEMP}/output.gif")"
    output_max_size="$(convert_mb $(toml $toml output.max_size))"
    echo -n "    size $uncompressed_size"
    [ -n "$output_max_size" ] && echo -n ", max_size $output_max_size"
    echo ''

    output_loss="$(toml $toml output.loss)"
    losses="${output_loss:-0}"
    gifsicle \
        -O3 \
        --lossy=$losses \
        --no-extensions \
        -o "${TEMP}/gifsicle.${losses}.gif" \
        "$TEMP/output.gif"

    size="$(stat -f '%z' "${TEMP}/gifsicle.${losses}.gif")"
    printf "  < optimised with loss %d, now %d, %.01f%% of original\n" \
        $losses \
        $size \
        "$(echo 3k $size $uncompressed_size / 100 \* p | dc)"

    if [ -n "$output_max_size" ]; then
        until [ "$size" -lt "$output_max_size" ]; do
            let "losses = losses + 10"

            gifsicle \
                -O3 \
                --lossy=$losses \
                --no-extensions \
                -o "${TEMP}/gifsicle.${losses}.gif" \
                "$TEMP/output.gif"

            size="$(stat -f '%z' "${TEMP}/gifsicle.${losses}.gif")"
            printf "  < optimised with loss %d, now %d, %.01f%% of max\n" \
                $losses \
                $size \
                "$(echo 3k $size $output_max_size / 100 \* p | dc)"
        done
    fi

    mv "$TEMP/gifsicle.${losses}.gif" "$gif"
}

function convert_mb {
    size="${1:-0}"

    case "$size" in
        *mb)
            echo "${size%%mb} 1024 1024 * * p" | dc | sed -e 's/\..*//'
            ;;
        0)
            echo ''
            ;;
        *)
            echo "$size"
            ;;
    esac
}

function debug {
    [ -n "$DEBUG" ] && echo "$@"
    "$@"
}

function join {
    local IFS="$1";
    shift;
    echo "$*" | tr -s ',' | sed -e 's/^,//' -e 's/,$//'
}

function cleanup {
    rm -rf "$TEMP"
}

TEMP="$(mktemp -d /tmp/make_gif.XXXXX)"
trap cleanup EXIT

main "$@"
